1) Vstupy & Cíl

Vstupy:

ANON: anonymizovaný text (např. smlouvaX_anon.docx přečtený do plain textu).

MAP: mapovací soubor (TXT/JSON) s položkami ve tvaru [[TAG_x]]: PŮVODNÍ_HODNOTA.

(Volitelně) ORIG: originální dokument pro diff.

Cíle auditu:

V ANON nesmí zůstat žádné nechráněné kritické údaje (karty, IBAN, hesla, API klíče, RČ…).

Každý tag v ANON musí mít položku v MAP s neprázdnou hodnotou (v test mode plné hodnoty).

Typ tagu musí odpovídat hodnotě (žádné RČ pod BANK apod.).

Osoby (PERSON) musí být validní osoby (ne instituce/místa), kanonika v 1. pádě; pádové tvary sloučené.

2) Normalizace (musí být shodná pro všechny auditory)

Před detekcemi a kontrolami proveď:

NBSP a zero-width

text = text.replace('\u00A0',' ') (NBSP → mezera)

odstraň [\u200B\u200C\u200D\uFEFF] (zero-width znaky)

Whitespace & řádky

slouč vícenásobné mezery na jednu

normalizuj konce řádků \r\n? → \n

Koncovky u tagů

akceptuj případy „nalepené“ na ]] (e-mail, telefon, měny)

Audit i anonymizátor musí vycházet z takto stejně normalizovaného textu.

3) Kategorie & precedence (pořadí detekcí)

Pořadí je závazné – vyšší má přednost:

CARD (13–19 číslic + Luhn)

IBAN

BIRTH_ID (RČ – s kontextem „RČ | Rodné číslo | nar.“)

ID_CARD (OP/pas)

EMAIL

USERNAME / ACCOUNT_ID

PASSWORD

API_KEY / SECRET

IP / HOST

PHONE (běž před AMOUNT)

BANK (CZ účet vč. prefixu \d{1,6}-\d{2,10}/\d{4})

ADDRESS (jen čisté adresy; bez prefixů/kontextových vět)

AMOUNT (číslo + měna; až po PHONE)

DATE

PERSON (validace proti knihovně + silný kontext; jinak ORG/PLACE/TERM)

Pozn.: V případě konfliktu rozhoduje vyšší precedence.

4) Test Mode vs. Production Mode (jen jedna volba)

TEST MODE (doporučeno při vývoji):
V MAP se zapisují plné hodnoty (žádné ***REDACTED***) – usnadňuje ladění a audit.

PRODUCTION MODE:
CARD, PASSWORD, API_KEY/SECRET zapisuj jako REDACTED (nebo last4 pro karty).

V auditu musí být jasně uvedeno, který režim se používá. (Níže defaultujeme na TEST MODE.)

5) Hard fails, majors, minors (definice)
5.1 Hard fails (kritické; každý = −3.0 bodu)

Musí být 0, jinak NO-GO.

any_plain_CARD – Luhn-valid karta v textu mimo [[CARD_*]].

any_plain_IBAN – IBAN v textu mimo [[IBAN_*]].

any_plain_PASSWORD – heslo v prostém textu (např. Heslo: qwerty123).

any_plain_API_SECRET – API/secret klíče v prostém textu.

any_plain_BIRTH_ID – RČ mimo [[BIRTH_ID_*]].

any_plain_EMAIL – e-mail mimo [[EMAIL_*]].

phone_misclassified_as_AMOUNT – telefon omylem pod AMOUNT.

idcard_misclassified_as_PHONE – OP/pas pod PHONE.

tag_in_text_missing_in_map – tag v textu nemá položku v mapě.

map_value_missing_or_empty – prázdná hodnota v mapě.

TEST MODE navíc: map_value_contains_redacted – v mapě nesmí být ***REDACTED***.

(Volitelně přidej any_plain_IP, any_plain_HOST jako hard fail, podle odvětví.)

5.2 Majors (významné; každý = −1.0 bodu)

Špatný typ (např. RČ pod BANK, VS pod PHONE, IBAN pod BANK apod.).

Nesoulad text ↔ mapa (hodnota v MAP neodpovídá hodnotě tagu v ANON).

ENTITY DRIFT u PERSON – instituce/místa/termíny tagovaná jako PERSON.

Nedostatečná redakce kontextu (např. karta otagovaná, ale CVV/exp. zůstaly).

Systémová nekonzistence PERSON (zřetelné sloučení dvou osob do jedné kanoniky).

5.3 Minors (kosmetika/kvalita; −0.3 až −0.5 za položku)

Prefixy v mapě u adres („Sídlo:“, „Trvalý pobyt:“) – má být čistá adresa.

„Nalepené“ znaky na tagy / typografické artefakty (]]Email: apod.).

PERSON kanonika není v 1. pádě.

ALL_CAPS varianty v mapě bez normalizace („DVORAKOVA“).

5.4 Bonusy (pozitivní; +0.2 až +0.3, max. +0.5 celkem)

Důsledný END-SCAN po náhradách (karty/IBAN/e-maily/telefony „nalepené“).

Implementovaná precedence dle §3, prokazatelně redukuje chyby.

Striktní validace PERSON (knihovna jmen + pádová kanonizace).

6) Skórování 0–10 (deterministické, s pevným max)

Start: score = 10.0

Odečty:

score -= 3.0 * count(HARD_FAILS)

score -= 1.0 * count(MAJORS)

score -= (0.3 nebo 0.5) * count(MINORS)
(zvol pevnou hodnotu 0.3, a 0.5 používej jen pro zvlášť rušivé případy)

Bonusy:

score += min(0.5, 0.3 * min(2, count(POSITIVE_ITEMS)))

Ořez a zaokrouhlení:

score = max(0.0, min(10.0, round(score, 1))) ⟵ 10.0 je tvrdý strop

Verdikt GO/NO-GO:

GO, pokud score ≥ 9.3 a současně HARD_FAILS == 0

Jinak NO-GO.

Pozn.: Když najdeš mnoho stejných chyb (např. 50× IBAN v plaintextu), počítej je poctivě do hard failů. Pokud chceš report učinit praktičtější, můžeš v textu uvést „systematický problém“ jednou, ale v počtu hard failů zůstane 50 – to drží metriku objektivní (a vysvětluje propad na 0/10).

7) Co přesně má auditor kontrolovat

ANON bez kritických plaintextů (podle hard fail definic).

1:1 pokrytí: každý [[TAG_x]] v ANON má položku v MAP a naopak žádná „osamocená“ mapová položka bez tagu.

Shoda typu a hodnoty: typ tagu odpovídá hodnotě v MAP (žádné RČ pod BANK; karta v CARD atd.).

PERSON kvalita: jen opravdové osoby (knihovna jmen/slovníky); kanonika 1. pád; pádové tvary sloučené.

Adresy v mapě: pouze čisté adresy (bez doprovodných vět/prefixů).

Precedence: konflikty řešit dle §3.

END-SCAN: po náhradách znovu prohledej karty (Luhn), IBAN, e-maily/telefony nalepené na ]].

8) Požadovaný výstup auditu (formát reportu)

VERDIKT: X.Y/10 → GO/NO-GO + jednověté zdůvodnění.

ODPOČTY (tabulka):

Hard fails: n × −3.0 = −…

Majors: n × −1.0 = −…

Minors: … = −…

Bonusy: +…

Konečné skóre: X.Y/10

KRITICKÉ NÁLEZY (HARD FAILS): očíslované, s doslovnou ukázkou z ANON.

DALŠÍ CHYBY (MAJOR/MINOR): stručně, s příkladem a správnou kategorií.

CO JE OK: 3–6 bodů (pozitivní).

FIX PLÁN (minimální zásah): konkrétní regex/precedence patch nebo post-pass.

Odhad skóre po fixech.

QA checklist (4–8 položek pro CI).

9) Pseudokód „audit runneru“ (pro jednotný výsledek)
def normalize(text: str) -> str:
    text = text.replace('\u00A0', ' ')
    text = re.sub(r'[\u200B\u200C\u200D\uFEFF]', '', text)
    text = re.sub(r'[ \t]+', ' ', text)
    text = text.replace('\r\n', '\n').replace('\r', '\n')
    return text

def extract_tags(text: str) -> set:
    return set(re.findall(r'\[\[[A-Z_]+_\d+\]\]', text))

def count_hard_fails(anon: str, amap: dict) -> int:
    n = 0
    if find_plain_card(anon): n += count_plain_cards(anon)
    if find_plain_iban(anon): n += count_plain_ibans(anon)
    # ... další hard pravidla ...
    missing = extract_tags(anon) - set(amap.keys())
    n += len(missing)  # tag v textu bez položky v mapě
    n += sum(1 for k,v in amap.items() if not v or not v.strip())
    if TEST_MODE:
        n += sum(1 for v in amap.values() if 'REDACTED' in v.upper())
    return n

def score(anon, amap, majors, minors, positives) -> (float, bool):
    s = 10.0
    s -= 3.0 * count_hard_fails(anon, amap)
    s -= 1.0 * majors
    s -= 0.3 * minors  # nebo 0.5 pro horší případy
    s += min(0.5, 0.3 * min(2, positives))
    s = max(0.0, min(10.0, round(s, 1)))  # cap to [0.0, 10.0]
    go = (s >= 9.3) and (count_hard_fails(anon, amap) == 0)
    return s, go


(Implementace find_plain_card, find_plain_iban, Luhn funkce, precedence a end-scan jsou vědomě vynechány – mají být totožné napříč auditory.)

10) CI / QA checklist (automatizovat v pipeline)

 NBSP/zero-width normalizace před auditem.

 END-SCAN: žádné Luhn-valid karty, IBANy, e-maily/telefony „nalepené“ na ]].

 Map coverage: extract_tags(ANON) == set(MAP.keys()), žádné prázdné hodnoty, v TEST MODE žádné REDACTED.

 Typová shoda: RČ jen BIRTH_ID, IBAN jen IBAN, VS není PHONE atd.

 PERSON validace: křestní jméno v knihovně nebo silný kontext; ne-osoby → ORG/PLACE/TERM.

 Adresy v mapě: bez prefixů („Sídlo:“, „Trvalý pobyt:“).

 Precedence dle §3.

 Skóre ≥ 9.3 a hard_fails == 0 → teprve pak GO.
